if("undefined"==typeof OGX)var OGX=function(){};OGX.plugins=function(){},OGX.prototype.MobileApi=function(e){"use strict";function i(e,i){var t={},s=getService(e);if(s){if(n(s,i))return t={success:!1,error:OGX.MobileApi.SERVICE_UNEXPECTED_DATA};var l=r(s,i);if(!l.success)return l;var c=o(s,i);return c.success?(t.success=!0,t):c}return t={success:!1,error:OGX.MobileApi.SERVICE_UNKNOWN}}function n(e,i){var n;if(e.fields)for(var r in i)if("token"!==r){n=!1;for(var o=0;o<e.fields.length;o++)if(r===e.fields[o].name){n=!0;break}if(!n)return!0}return!1}function r(e,i){var n={success:!0};if(e.fields)for(var r=0;r<e.fields.length;r++)e.fields[r].required&&(i.hasOwnProperty(e.fields[r].name)?String(i[e.fields[r].name])||(n.success=!1,n.error=OGX.MOBiLEAPI.SERVICE_REQUIRED_FIELDS_MISSING,n.fields||(n.fields=[]),n.fields.push(e.fields[r].name)):(n.success=!1,n.error=OGX.MOBiLEAPI.SERVICE_REQUIRED_FIELDS_MISSING,n.fields||(n.fields=[]),n.fields.push(e.fields[r].name)));return n}function o(e,i){var n={success:!1,fields:[]};if(e.fields)for(var r in i)for(var o=0;o<e.fields.length;o++)if(e.fields[o].name===r){if(e.fields[o].array&&e.fields[o].preg)for(var s=0;s<i[r].length;s++)t(e.fields[o].preg,i[r][s])||n.fields.indexOf(r)===-1&&n.fields.push({field:r,value:i[r][s],preg:e.fields[o].preg});else e.fields[o].preg&&String(i[r]).length>0&&(t(e.fields[o].preg,i[r])||n.fields.indexOf(r)===-1&&n.fields.push({field:r,value:i[r],preg:e.fields[o].preg}));break}return 0===n.fields.length?(delete n.fields,n.success=!0):n.error=OGX.MOBiLEAPI.SERVICE_INCORRECT_DATA,n}function t(e,i){var n=new RegExp(e[0],e[1]);return n.test(i)}function s(e,i,n,r,o){if(D.tokens.client.access_token||D.tokens.user.access_token){var t;if(P.logged){if(v(D.tokens.user))return P.logged=!1,V="renewToken",x.push({service:e,data:i,callback:n,params:r}),void y.login(P.username,P.hash,!0,!1);var s=b(D.tokens.user);if(s&&s<1800)return x.push({service:e,data:i,callback:n,params:r}),void k();t=D.tokens.user.access_token}else{if(v(D.tokens.client))return V="renewToken",x.push({service:e,data:i,callback:n,params:r}),void G(!1,!0);t=D.tokens.client.access_token}var c=window.location.href;D.url&&(c=D.url);var u={uuid:D.uuid,service:e,data:i,access_token:t},a=JSON.stringify(u);$.ajax({method:"POST",url:D.url,data:a,async:!0,processData:!1,contentType:"application/json",dataType:"json",success:function(o,t,s){if(o.success)n?r?n(o,r):n(o):$(document).trigger(OGX.MobileApi.SERVICE_DATA,o),l();else switch(o.error){case OGX.MobileApi.SESSION_EXPIRED:P.logged&&f(),$(document).trigger(OGX.MobileApi.SESSION_EXPIRED);break;case OGX.MobileApi.SCOPE_INVALID:P.logged&&f(),$(document).trigger(OGX.MobileApi.SCOPE_INVALID);break;case OGX.MobileApi.TOKEN_INVALID:console.log("INVALID TOKEN - LOGGED IN FROM ANOTHER DEVICE or password change?"),D.auto_log&&P.hash&&(V="userToken",x.push({service:e,data:i,callback:n,params:r}),p(P.username,P.hash,!0)),$(document).trigger(OGX.MobileApi.TOKEN_INVALID)}},error:function(e,i,n){$(document).trigger(OGX.MobileApi.ERROR_NETWORK)}})}}function l(){if(x.length>0){V="backlog";var e=x.shift();y.call(e.service,e.data,e.callback,e.params)}else V="ready",$(document).trigger(OGX.MobileApi.SESSION_READY)}function c(e,i){var n=u(e,i),r=localStorage.getItem(n);return!!r&&$.parseJSON(r)}function u(e,i){var n=e+i.toString(),r=CryptoJS.SHA256(n);return r}function a(){var e=!1;return e=D.debug||"undefined"==typeof device?"00000-0000-0000-00000":device.uuid}function O(e){$.getJSON(D.services,function(i){i?(D.services=i,e()):(e({error:"Cant load services"}),$(D.container).trigger(OGX.MobileApi.ERROR_GENERIC,{error:"Cant load services"}))})}function p(e,i,n,r){console.log("LOGIN with",e,i),$.ajax({method:"POST",url:D.url,data:JSON.stringify({uuid:D.uuid,username:e,password:i,client_id:D.client_id,client_secret:D.client_secret,grant_type:"password"}),async:!0,processData:!1,contentType:"application/json",success:function(o,t,s){o.success?o.access_token&&(console.log("LOGIN SUCCESS"),d(o,e,i,n,r)):(S(),$(document).trigger(OGX.MobileApi.LOGIN_ERROR,{error:"Invalid email/password combination"}))},error:function(e,i,n){$(document).trigger(OGX.MobileApi.ERROR_NETWORK)}})}function d(e,i,n,r,o){D.tokens.user.access_token=e.access_token,D.tokens.user.refresh_token=e.refresh_token,D.tokens.user.expire=moment().unix()+e.expires_in-10,g(P,e.user),P.hash=n,P.logged=!0,A(),_(),l(),r||$(document).trigger(OGX.MobileApi.LOGIN_SUCCESS),o&&o()}function f(){$.ajax({method:"POST",url:D.url,data:JSON.stringify({grant_type:"logout",access_token:D.tokens.user.access_token}),async:!0,processData:!1,contentType:"application/json",success:function(e,i,n){D.tokens.user.access_token=0,D.tokens.user.refresh_token=0,D.tokens.user.expire=0,P.logged=!1,A(),_(),$(document).trigger(OGX.MobileApi.LOGOUT_SUCCESS)},error:function(e,i,n){D.tokens.user.access_token=0,D.tokens.user.refresh_token=0,D.tokens.user.expire=0,P.logged=!1,A(),_(),$(document).trigger(OGX.MobileApi.LOGOUT_ERROR)}})}function g(e,i){for(var n in i)e[n]=i[n]}function E(){var e=localStorage.getItem("user");e?(P=$.parseJSON(e),P._id||S()):S()}function _(){var e=JSON.stringify(P);e&&localStorage.setItem("user",e)}function S(){P=$.parseJSON(JSON.stringify(U)),P.logged=!1,_()}function R(){var e=localStorage.getItem("tokens");return!!e&&(console.log("LOADED TOKENS",e),$.parseJSON(e))}function A(){localStorage.setItem("tokens",JSON.stringify(D.tokens))}function I(){D.tokens={client:{access_token:null,refresh_token:null,expire:0},user:{access_token:null,refresh_token:null,expire:0}},A()}function k(){console.log("REFRESH USER TOKEN"),V="refreshToken",$.ajax({method:"POST",url:D.url,data:JSON.stringify({grant_type:"refresh_token",client_id:D.client_id,client_secret:D.client_secret,refresh_token:D.tokens.user.refresh_token}),async:!0,processData:!1,contentType:"application/json",success:function(e,i,n){D.tokens.user.access_token=e.access_token,D.tokens.user.refresh_token=e.refresh_token,D.tokens.user.expire=moment().unix()+e.expires_in,A(),l(),$(document).trigger(OGX.MobileApi.TOKEN_REFRESHED)},error:function(e,i,n){V="error",$(document).trigger(OGX.MobileApi.TOKEN_REFRESH_ERROR,n)}})}function G(e,i){V="clientToken",$.ajax({method:"POST",url:D.url,data:JSON.stringify({grant_type:"client_credentials",client_id:D.client_id,client_secret:D.client_secret,version:D.version}),async:!0,processData:!1,contentType:"application/json",success:function(n,r,o){n.hasOwnProperty("success")&&!n.success&&$(document).trigger(n.error,n),V="ready",D.tokens.client.access_token=n.access_token,D.tokens.client.expire=moment().unix()+n.expires_in,A(),$(document).trigger(OGX.MobileApi.TOKEN_CLIENT),e&&P&&p(P.username,P.hash,!0),i&&l()},error:function(e,i,n){V="error",$(document).trigger(OGX.MobileApi.TOKEN_CLIENT_ERROR,n)}})}function v(e){return e.expire<moment().unix()}function b(e){return e.expire-moment().unix()}function N(){V="initTokens";var e=!1,i=!1,n=R();if(n)if(D.tokens=n,D.tokens.user.access_token){if(D.auto_log&&P){if(!v(D.tokens.user))return V="ready",void $(document).trigger(OGX.MobileApi.LOGIN_SOFT);if(!D.tokens.client||!v(D.tokens.client))return void p(P.username,P.hash,!0);i=!0,e=!0}}else D.tokens.client.access_token?v(D.tokens.client)&&(i=!0):i=!0;else I(),i=!0;return console.log("FETCH",e,i),i?void G(e):void(V="ready")}function h(e,i){if(e){var n=new OGX.plugins[i](D.plugins[i]);return y.plugins[i]=n,!0}return y.plugins[i].kill&&y.plugins[i].kill(),y.plugins[i]=null,!0}function M(e){return!!y.plugins.hasOwnProperty(e)&&y.plugins[e]}function X(e){if(e){var i;for(var n in D.plugins)i=new OGX.plugins[n](D.plugins[n]),y.plugins[n]=i}else{for(var n in plugins)y.plugins[n].hasOwnProperty("kill")&&y.plugins[n].kill();y.plugins={}}}function T(){"undefined"==typeof D&&(D={});for(var e in L)D.hasOwnProperty(e)||(D[e]=L[e]);D.uuid=a()}function m(){D.force_new&&I(),E(),D.load_plugins&&setTimeout(X(!0),0),setTimeout(N(),0)}function C(){return"undefined"==typeof CryptoJS?void console.log("%c CRITICAL ERROR - CryptoJS not found! ","background:#222; color: #FF0000"):"undefined"==typeof moment?void console.log("%c CRITICAL ERROR - MomentJS not found! ","background:#222; color: #FF0000"):(T(),void(D.validate&&D.services?O():m()))}var y=this,D=e,L={debug:!1,client_id:null,client_secret:null,uuid:null,tokens:null,device_token:!1,services:null,validate:!1,load_plugins:!1,force_new:!1,force_refresh:!1,auto_log:!0,version:"1.0.0"},P={},U={_id:null,username:null,first_name:null,last_name:null,image_https:null,home:{city:null,country:null,state:null,zip:null,lat:null,lng:null,address:0},logged:!1,scope:["public"]},x=[],V="init";this.plugins={},this.type="OgxApi",this.updateUser=function(e,i){for(var n in e)P.hasOwnProperty(n)&&(P[n]=e[n]);_()},this.updateUserProp=function(e,i){P[e]=i,_()},this.getUser=function(){return P},this.loadPlugin=function(e){return h(!0,e)},this.storeObject=function(e,i){localStorage.setItem(e,JSON.stringify(i))},this.getObject=function(e){var i=localStorage.getItem(e);return!!i&&$.parseJSON(i)},this.isLogged=function(){return P.logged},this.login=function(e,i,n,r){if("undefined"==typeof n&&(n=!1),"undefined"==typeof r&&(r=!0),!n&&P.logged)return"already logged";var o=i;r&&(o=CryptoJS.MD5(i).toString()),p(e,o,!1)},this.logout=function(){f()},this.call=function(e,n,r,o,t){var l=!0;if(D.validate){l=!1;var u=i(e,n);if(u.success)if(u.stored){var a=c(e,n),O=new Date;parseInt(a.stored)+u.service.store_expire/1e3/60<O.getTime()?r?o?r(a.data,o):r(a.data):$(document).trigger(OGX.MobileApi.SERVICE_DATA,a.data):l=!0}else l=!0;else r?(u.front=!0,r(u)):$(document).trigger(OGX.MobileApi.SERVICE_INPUT_ERROR,u)}return"ready"!==V&&"backlog"!==V?void(l&&x.push({service:e,data:n,callback:r,params:o})):void(l&&setTimeout(function(){s(e,n,r,o,t)},0))},this.validate=function(e,n){var r=i(e,n);return r},this.getUUID=function(){return D.uuid},this.getPlugin=function(e){return M(e)},C()},OGX.MobileApi=function(e){"use strict";return new OGX.prototype.MobileApi(e)},OGX.MobileApi.CRITICAL_ERROR="criticalError",OGX.MobileApi.SERVICE_INPUT_ERROR="serviceInputError",OGX.MobileApi.SERVICE_UNEXPECTED_DATA="serviceUnexpectedData",OGX.MobileApi.SERVICE_INCORRECT_DATA="serviceIncorrectData",OGX.MobileApi.SERVICE_REQUIRED_FIELDS_MISSING="serviceRequiredFieldsMissing",OGX.MobileApi.SERVICE_UNAVAILABLE="serviceUnavailable",OGX.MobileApi.SERVICE_UNKNOWN="serviceUnknown",OGX.MobileApi.SERVICE_DATA="serviceData",OGX.MobileApi.SERVICE_SPAM="serviceSpam",OGX.MobileApi.USER_SESSION_EXPIRED="userSessionExpired",OGX.MobileApi.SESSION_EXPIRED="expired_token",OGX.MobileApi.SESSION_INVALID="sessionInvalid",OGX.MobileApi.SESSION_READY="sessionReady",OGX.MobileApi.SESSION_ERROR="sessionError",OGX.MobileApi.SESSION_RESTART="sessionRestart",OGX.MobileApi.SCOPE_INVALID="scopeInvalid",OGX.MobileApi.LOGIN_ERROR="loginError",OGX.MobileApi.LOGIN_SUCCESS="loginSuccess",OGX.MobileApi.LOGIN_SOFT="loginSoft",OGX.MobileApi.LOGOUT="logOut",OGX.MobileApi.LOGOUT_SUCCESS="logOutSuccess",OGX.MobileApi.LOGOUT_ERROR="logOutError",OGX.MobileApi.TOKEN_INVALID="invalidToken",OGX.MobileApi.TOKEN_MISSING="tokenMissing",OGX.MobileApi.TOKEN_REFRESHED="tokenRefreshed",OGX.MobileApi.TOKEN_CLIENT="tokenClient",OGX.MobileApi.TOKEN_CLIENT_ERROR="tokenClientError",OGX.MobileApi.TOKEN_REFRESH_ERROR="tokenRefreshError",OGX.MobileApi.ERROR_FILE_SIZE="errorFileSize",OGX.MobileApi.ERROR_GENERIC="errorGeneric",OGX.MobileApi.ERROR_NETWORK="errorNetwork",OGX.MobileApi.VERSION_OBSOLETE="versionObsolete",OGX.MobileApi.UPLOAD_START="uploadStart",OGX.MobileApi.UPLOAD_ABORTED="uploadAborted",OGX.MobileApi.UPLOAD_COMPLETE="uploadComplete",OGX.MobileApi.UPLOAD_PROGRESS="uploadProgress";