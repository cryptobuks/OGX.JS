if("undefined"==typeof OGX)var OGX=function(){};OGX.plugins=function(){},OGX.prototype.MobileApi=function(e){"use strict";function i(e,i){var o={},s=getService(e);if(s){if(n(s,i))return o={success:!1,error:OGX.MobileApi.SERVICE_UNEXPECTED_DATA};var c=r(s,i);if(!c.success)return c;var l=t(s,i);return l.success?(o.success=!0,o):l}return o={success:!1,error:OGX.MobileApi.SERVICE_UNKNOWN}}function n(e,i){var n;if(e.fields)for(var r in i)if("token"!==r){n=!1;for(var t=0;t<e.fields.length;t++)if(r===e.fields[t].name){n=!0;break}if(!n)return!0}return!1}function r(e,i){var n={success:!0};if(e.fields)for(var r=0;r<e.fields.length;r++)e.fields[r].required&&(i.hasOwnProperty(e.fields[r].name)?String(i[e.fields[r].name])||(n.success=!1,n.error=OGX.MOBiLEAPI.SERVICE_REQUIRED_FIELDS_MISSING,n.fields||(n.fields=[]),n.fields.push(e.fields[r].name)):(n.success=!1,n.error=OGX.MOBiLEAPI.SERVICE_REQUIRED_FIELDS_MISSING,n.fields||(n.fields=[]),n.fields.push(e.fields[r].name)));return n}function t(e,i){var n={success:!1,fields:[]};if(e.fields)for(var r in i)for(var t=0;t<e.fields.length;t++)if(e.fields[t].name===r){if(e.fields[t].array&&e.fields[t].preg)for(var s=0;s<i[r].length;s++)o(e.fields[t].preg,i[r][s])||n.fields.indexOf(r)===-1&&n.fields.push({field:r,value:i[r][s],preg:e.fields[t].preg});else e.fields[t].preg&&String(i[r]).length>0&&(o(e.fields[t].preg,i[r])||n.fields.indexOf(r)===-1&&n.fields.push({field:r,value:i[r],preg:e.fields[t].preg}));break}return 0===n.fields.length?(delete n.fields,n.success=!0):n.error=OGX.MOBiLEAPI.SERVICE_INCORRECT_DATA,n}function o(e,i){var n=new RegExp(e[0],e[1]);return n.test(i)}function s(e,i,n,r,t){if(x.tokens.client.access_token||x.tokens.user.access_token){var o;if(w.logged){if(b(x.tokens.user))return w.logged=!1,F="renewToken",J.push({service:e,data:i,callback:n,params:r}),void P.login(w.username,w.hash,!0,!1);var s=G(x.tokens.user);if(s&&s<1800)return J.push({service:e,data:i,callback:n,params:r}),void I();o=x.tokens.user.access_token}else{if(b(x.tokens.client))return F="renewToken",J.push({service:e,data:i,callback:n,params:r}),void k(!1,!0);o=x.tokens.client.access_token}var u=window.location.href;x.url&&(u=x.url);var p={uuid:x.uuid,service:e,data:i,access_token:o},f=JSON.stringify(p);if(x.caching){var d=a(e,i);if(d)return n?r?n(d.response,r):n(d.response):$(document).trigger(OGX.MobileApi.SERVICE_DATA,d.response),void c()}$.ajax({method:"POST",url:x.url,data:f,async:!0,processData:!1,contentType:"application/json",dataType:"json",success:function(t,o,s){if(t.success)x.caching&&t.hasOwnProperty("cache")&&t.cache&&l(e,i,t),n?r?n(t,r):n(t):$(document).trigger(OGX.MobileApi.SERVICE_DATA,t),c();else switch(t.error){case OGX.MobileApi.SESSION_EXPIRED:w.logged&&g(),$(document).trigger(OGX.MobileApi.SESSION_EXPIRED);break;case OGX.MobileApi.SCOPE_INVALID:w.logged&&g(),$(document).trigger(OGX.MobileApi.SCOPE_INVALID);break;case OGX.MobileApi.TOKEN_INVALID:console.log("INVALID TOKEN - LOGGED IN FROM ANOTHER DEVICE or password change?"),x.auto_log&&w.hash&&(F="userToken",J.push({service:e,data:i,callback:n,params:r}),O(w.username,w.hash,!0)),$(document).trigger(OGX.MobileApi.TOKEN_INVALID)}},error:function(e,i,n){$(document).trigger(OGX.MobileApi.ERROR_NETWORK)}})}}function c(){if(J.length>0){F="backlog";var e=J.shift();P.call(e.service,e.data,e.callback,e.params)}else F="ready",$(document).trigger(OGX.MobileApi.SESSION_READY)}function l(e,i,n){"{}"===JSON.stringify(i)&&(i=null);var r=u(e,i);"string"==typeof n&&(n=$.parseJSON(n));var t=new Date,o={hash:r,time:t.getTime(),response:n},s=L.find({hash:r},null,1);s&&s.hasOwnProperty("_id")?L.replaceOne({hash:r},o):L.insert(o)}function a(e,i){"{}"===JSON.stringify(i)&&(i=null);var n=u(e,i),r=L.find({hash:n},null,1);for(var t in r){var o=r[t];if(o&&o.hasOwnProperty("_id"))return(new Date).getTime()/1e3<o.response.cache_expiry?o:(L.deleteOne({hash:n}),!1);break}return!1}function u(e,i){"undefined"!=typeof i&&i?(i=JSON.stringify(i),"{}"===i&&(i=!1)):i=!1;var n=CryptoJS.SHA256(e).toString();return i&&(n+="_"+CryptoJS.SHA256(i).toString()),n}function p(){var e=!1;return e=x.debug||"undefined"==typeof device?"00000-0000-0000-00000":device.uuid}function f(e){$.getJSON(x.services,function(i){i?(x.services=i,e()):(e({error:"Cant load services"}),$(x.container).trigger(OGX.MobileApi.ERROR_GENERIC,{error:"Cant load services"}))})}function O(e,i,n,r){$.ajax({method:"POST",url:x.url,data:JSON.stringify({uuid:x.uuid,username:e,password:i,client_id:x.client_id,client_secret:x.client_secret,grant_type:"password"}),async:!0,processData:!1,contentType:"application/json",success:function(t,o,s){t.success?t.access_token&&d(t,e,i,n,r):(R(),$(document).trigger(OGX.MobileApi.LOGIN_ERROR,{error:"Invalid email/password combination"}))},error:function(e,i,n){$(document).trigger(OGX.MobileApi.ERROR_NETWORK)}})}function d(e,i,n,r,t){x.tokens.user.access_token=e.access_token,x.tokens.user.refresh_token=e.refresh_token,x.tokens.user.expire=moment().unix()+e.expires_in-10,_(w,e.user),w.hash=n,w.logged=!0,A(),S(),c(),r||$(document).trigger(OGX.MobileApi.LOGIN_SUCCESS),t&&t()}function g(){$.ajax({method:"POST",url:x.url,data:JSON.stringify({grant_type:"logout",access_token:x.tokens.user.access_token}),async:!0,processData:!1,contentType:"application/json",success:function(e,i,n){x.tokens.user.access_token=0,x.tokens.user.refresh_token=0,x.tokens.user.expire=0,w.logged=!1,A(),S(),$(document).trigger(OGX.MobileApi.LOGOUT_SUCCESS)},error:function(e,i,n){x.tokens.user.access_token=0,x.tokens.user.refresh_token=0,x.tokens.user.expire=0,w.logged=!1,A(),S(),$(document).trigger(OGX.MobileApi.LOGOUT_ERROR)}})}function _(e,i){for(var n in i)e[n]=i[n]}function E(){var e=localStorage.getItem("user");e?(w=$.parseJSON(e),w._id||R()):R()}function S(){var e=JSON.stringify(w);return!!e&&(localStorage.setItem("user",e),!0)}function R(){w=$.parseJSON(JSON.stringify(V)),w.logged=!1,S()}function h(){var e=localStorage.getItem("tokens");return!!e&&$.parseJSON(e)}function A(){localStorage.setItem("tokens",JSON.stringify(x.tokens))}function v(){x.tokens={client:{access_token:null,refresh_token:null,expire:0},user:{access_token:null,refresh_token:null,expire:0}},A()}function I(){F="refreshToken",$.ajax({method:"POST",url:x.url,data:JSON.stringify({grant_type:"refresh_token",client_id:x.client_id,client_secret:x.client_secret,refresh_token:x.tokens.user.refresh_token}),async:!0,processData:!1,contentType:"application/json",success:function(e,i,n){x.tokens.user.access_token=e.access_token,x.tokens.user.refresh_token=e.refresh_token,x.tokens.user.expire=moment().unix()+e.expires_in,A(),c(),$(document).trigger(OGX.MobileApi.TOKEN_REFRESHED)},error:function(e,i,n){F="error",$(document).trigger(OGX.MobileApi.TOKEN_REFRESH_ERROR,n)}})}function k(e,i){F="clientToken",$.ajax({method:"POST",url:x.url,data:JSON.stringify({grant_type:"client_credentials",client_id:x.client_id,client_secret:x.client_secret,version:x.version}),async:!0,processData:!1,contentType:"application/json",success:function(n,r,t){n.hasOwnProperty("success")&&!n.success&&$(document).trigger(n.error,n),F="ready",x.tokens.client.access_token=n.access_token,x.tokens.client.expire=moment().unix()+n.expires_in,A(),$(document).trigger(OGX.MobileApi.TOKEN_CLIENT),e&&w&&O(w.username,w.hash,!0),i&&c()},error:function(e,i,n){F="error",$(document).trigger(OGX.MobileApi.TOKEN_CLIENT_ERROR,n)}})}function b(e){return e.expire<moment().unix()}function G(e){return e.expire-moment().unix()}function N(){F="initTokens";var e=!1,i=!1,n=h();if(n)if(x.tokens=n,x.tokens.user.access_token){if(x.auto_log&&w){if(!b(x.tokens.user))return F="ready",void $(document).trigger(OGX.MobileApi.LOGIN_SOFT);if(!x.tokens.client||!b(x.tokens.client))return void O(w.username,w.hash,!0);i=!0,e=!0}}else x.tokens.client.access_token?b(x.tokens.client)&&(i=!0):i=!0;else v(),i=!0;return i?void k(e):void(F="ready")}function M(e,i){if(e){var n=new OGX.plugins[i](x.plugins[i]);return P.plugins[i]=n,!0}return P.plugins[i].kill&&P.plugins[i].kill(),P.plugins[i]=null,!0}function X(e){return!!P.plugins.hasOwnProperty(e)&&P.plugins[e]}function m(e){if(e){var i;for(var n in x.plugins)i=new OGX.plugins[n](x.plugins[n]),P.plugins[n]=i}else{for(var n in plugins)P.plugins[n].hasOwnProperty("kill")&&P.plugins[n].kill();P.plugins={}}}function T(){x.force_new&&v(),E(),x.load_plugins&&setTimeout(m(!0),0),setTimeout(N(),0)}function y(){if(L=new OGX.Mongogx,L.createDatabase("api_cache"),L.setDatabase("api_cache"),L.createCollection("services"),L.setCollection("services"),x.clear_cache_once){var e=P.getObject("clear_cache");e||(L.deleteDatabase("api_cache"),L.createDatabase("api_cache"),L.createCollection("services"),L.setCollection("services"),P.storeObject("clear_cache","true"))}}function C(){"undefined"==typeof x&&(x={});for(var e in U)x.hasOwnProperty(e)||(x[e]=U[e]);x.uuid=p()}function D(){return"undefined"==typeof CryptoJS?void console.log("%c CRITICAL ERROR - CryptoJS not found! ","background:#222; color: #FF0000"):"undefined"==typeof moment?void console.log("%c CRITICAL ERROR - MomentJS not found! ","background:#222; color: #FF0000"):(C(),x.caching&&"undefined"==typeof OGX.Mongogx?void console.log("%c CRITICAL ERROR - Mongogx not found! ","background:#222; color: #FF0000"):(x.caching&&y(),void(x.validate&&x.services?f():T())))}var L,P=this,x=e,U={debug:!1,client_id:null,client_secret:null,uuid:null,tokens:null,device_token:!1,services:null,validate:!1,load_plugins:!1,force_new:!1,force_refresh:!1,auto_log:!0,version:"1.0.0",caching:!0,clear_cache_once:!1},w={},V={_id:null,username:null,first_name:null,last_name:null,image_https:null,home:{city:null,country:null,state:null,zip:null,lat:null,lng:null,address:0},logged:!1,scope:["public"]},J=[],F="init";this.plugins={},this.updateUser=function(e){for(var i in e)w.hasOwnProperty(i)&&(w[i]=e[i]);return S()},this.updateUserProp=function(e,i){return w[e]=i,S()},this.getUser=function(){return w},this.loadPlugin=function(e){return M(!0,e)},this.storeObject=function(e,i){localStorage.setItem(e,JSON.stringify(i))},this.getObject=function(e){var i=localStorage.getItem(e);return!!i&&$.parseJSON(i)},this.isLogged=function(){return w.logged},this.login=function(e,i,n,r){if("undefined"==typeof n&&(n=!1),"undefined"==typeof r&&(r=!0),!n&&w.logged)return"already logged";var t=i;r&&(t=CryptoJS.MD5(i).toString()),O(e,t,!1)},this.logout=function(){g()},this.call=function(e,n,r,t,o){var c=!0;if("undefined"==typeof n&&(n={}),x.validate){c=!1;var l=i(e,n);l.success?c=!0:r?(l.front=!0,r(l)):$(document).trigger(OGX.MobileApi.SERVICE_INPUT_ERROR,l)}return"ready"!==F&&"backlog"!==F?void(c&&J.push({service:e,data:n,callback:r,params:t})):void(c&&setTimeout(function(){s(e,n,r,t,o)},0))},this.validate=function(e,n){var r=i(e,n);return r},this.getUUID=function(){return x.uuid},this.getPlugin=function(e){return X(e)},this.uncacheService=function(e,i){var n=u(e,i);return L.deleteOne({hash:n})},this.uncacheServices=function(e){var i=u(e);return L.deleteMany({hash:{$in:i}})},D()},OGX.MobileApi=function(e){"use strict";return new OGX.prototype.MobileApi(e)},OGX.MobileApi.CRITICAL_ERROR="criticalError",OGX.MobileApi.SERVICE_INPUT_ERROR="serviceInputError",OGX.MobileApi.SERVICE_UNEXPECTED_DATA="serviceUnexpectedData",OGX.MobileApi.SERVICE_INCORRECT_DATA="serviceIncorrectData",OGX.MobileApi.SERVICE_REQUIRED_FIELDS_MISSING="serviceRequiredFieldsMissing",OGX.MobileApi.SERVICE_UNAVAILABLE="serviceUnavailable",OGX.MobileApi.SERVICE_UNKNOWN="serviceUnknown",OGX.MobileApi.SERVICE_DATA="serviceData",OGX.MobileApi.SERVICE_SPAM="serviceSpam",OGX.MobileApi.USER_SESSION_EXPIRED="userSessionExpired",OGX.MobileApi.SESSION_EXPIRED="expired_token",OGX.MobileApi.SESSION_INVALID="sessionInvalid",OGX.MobileApi.SESSION_READY="sessionReady",OGX.MobileApi.SESSION_ERROR="sessionError",OGX.MobileApi.SESSION_RESTART="sessionRestart",OGX.MobileApi.SCOPE_INVALID="scopeInvalid",OGX.MobileApi.LOGIN_ERROR="loginError",OGX.MobileApi.LOGIN_SUCCESS="loginSuccess",OGX.MobileApi.LOGIN_SOFT="loginSoft",OGX.MobileApi.LOGOUT="logOut",OGX.MobileApi.LOGOUT_SUCCESS="logOutSuccess",OGX.MobileApi.LOGOUT_ERROR="logOutError",OGX.MobileApi.TOKEN_INVALID="invalidToken",OGX.MobileApi.TOKEN_MISSING="tokenMissing",OGX.MobileApi.TOKEN_REFRESHED="tokenRefreshed",OGX.MobileApi.TOKEN_CLIENT="tokenClient",OGX.MobileApi.TOKEN_CLIENT_ERROR="tokenClientError",OGX.MobileApi.TOKEN_REFRESH_ERROR="tokenRefreshError",OGX.MobileApi.ERROR_FILE_SIZE="errorFileSize",OGX.MobileApi.ERROR_GENERIC="errorGeneric",OGX.MobileApi.ERROR_NETWORK="errorNetwork",OGX.MobileApi.VERSION_OBSOLETE="versionObsolete",OGX.MobileApi.UPLOAD_START="uploadStart",OGX.MobileApi.UPLOAD_ABORTED="uploadAborted",OGX.MobileApi.UPLOAD_COMPLETE="uploadComplete",OGX.MobileApi.UPLOAD_PROGRESS="uploadProgress";